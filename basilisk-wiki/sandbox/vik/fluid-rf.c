#include "grid/multigrid1D.h"
#include "utils.h"
#include "timestep.h"
#include "run.h"

// --- physical constants:
#define Uanode 0.0
#define eps0 8.89e-12
#define qe 1.6e-19
#define k_boltz 1.38e-23 //Boltzmann constant
#define me 9.11e-31 //electron mass
#define mi (4.0*1.67e-27) //ion mass
#define Tgas 300.0 //background gas temperature
#define e_ion 24.58 //ionization energy in [eV]
#define ex1 19.8 //excitation energy in [eV]

#define PI (pi)
#define ne_min (1e6)
#define n0 (3.84e14) // (1e13) //initial plasma density; in [1/m3]

// --- function prototypes:
double ion_coeff_te(double);
double e_mobility_te(double, double);
double moment_coeff_te(double);
double eps_gas(double);
double coeff_ex1_te(double);
double mobi_ion(double);

void drift_diffusion(double [],double [],double [], double [], double, double, double, double, int);
double W_dd(double);
double B_dd(double);
void tdma(double [], double [], double [], double [], double , double , double [], int);
void update_phi(double [], double , double , double [], int );
// ------------------------------------------------------------------------
#define LEVEL 9 //refinement level

#define rf_freq (13.56e6)
#define rf_period (1.0/rf_freq)

#define Ucath (-200.0)
#define box_size (6.7e-2) //in [m]

#define ng0 (321e20) //gas density; in [1/m3]
#define gas_press (ng0*Tgas*k_boltz)

#define multi_mu_i (760.0*Tgas*133.33/(273.16*gas_press)*1e-4)

#define n_periods (1000.0) //number of periods to execute the program
#define time_step (5e-10/2.0) // time step

#define iend ((int)(n_periods*rf_period/time_step+1))
#define tend (n_periods*rf_period)
#define steps_per_period ((int)(rf_period/time_step))
#define i_write 20

#define ve_th (sqrt(8.0*k_boltz*8.0*11600.0/PI/me))

#define Volt(t) (Ucath*cos(2.0*PI*t*rf_freq)) //applied voltage; in [V]

static FILE * fp_currents = NULL;

double field_r_old = 0.0;
double field_r_new = 0.0;

double Ucath_upd = Ucath;
double ne_bc_left,ne_bc_right;
double ni_bc_left,ni_bc_right;
double neps_bc_left,neps_bc_right;
double Ii_r,Ii_l,Ie_r,Ie_l,Ii_c,Ie_c;
double I_displ = 0.0;
double field_w_old = 0.0;
double field_w = 0.0;

#define size_N (1<<LEVEL)

double ne_1d[size_N];
double De_1d[size_N];
double ve_1d[size_N];
double mue_1d[size_N];
double Kion_1d[size_N];

double ni_1d[size_N];
double Di_1d[size_N];
double vi_1d[size_N];
double mui_1d[size_N];
double Kioni_1d[size_N];
double gamma_e_1d[size_N];
double gamma_e_adv[size_N];
double gamma_e_diff[size_N];
double gamma_i_1d[size_N];

double neps_1d[size_N];
double Deps_1d[size_N];
double ve_eps_1d[size_N];
double Keps[size_N];

double phi_1d[size_N];
double field_1d[size_N];
double Te_1d[size_N];
double rhs_1d[size_N];

// --- initial conditions:
event init(i=0){

  DT = time_step;
  dt = dtnext(time_step);

  fprintf(stdout,"Time ne dt I_ion I_el Ucath Te\n");
  fflush(stdout);

  fp_currents = fopen("currents.dat","w");
  fprintf(fp_currents,"t Ucath0 Ucath Ii_r Ii_l Ii_c Ie_r Ie_l Ie_c I_displ field\n");
  fflush(fp_currents);

  for (int j = 0; j < size_N; j++){
    ne_1d[j] = n0;
    ni_1d[j] = n0;
    Te_1d[j] = 10.0*1160.0;
    neps_1d[j] = 3.0/2.0*k_boltz*Te_1d[j];
    phi_1d[j] = 0.0;
  }

}

int main(){

  L0 = box_size;
  origin(0.0);
  init_grid (1 << LEVEL);
  run();
}

event properties2(i++,last){

  field_w_old = field_w;
  dt = dtnext(time_step);

  field_r_old = field_r_new;

  double dx1 = L0/(float)(size_N);
  double dt1 = dt;

  Te_1d[0] = Te_1d[size_N-1] = 11600.0;
  ne_1d[0] = ne_bc_left = 0.0;
  neps_1d[0] = neps_bc_left = 0.0;
  ni_1d[0] = ni_bc_left = 0.0;

  ne_1d[size_N-1] = ne_bc_right = 0.0;
  neps_1d[size_N-1] = neps_bc_right = 0.0;
  ni_1d[size_N-1] = ni_bc_right = 0.0;

  phi_1d[0] = Volt(t);
  phi_1d[size_N-1] = 0.0;

  for (int j = 0; j < size_N; j++)
    rhs_1d[j] = sq(dx1)*qe/eps_gas(300.0)*(ne_1d[j]-ni_1d[j]);

  update_phi(phi_1d,Uanode,phi_1d[0],rhs_1d,size_N);

  for (int j = 1; j < size_N-1; j++)
    field_1d[j] = -0.5*(phi_1d[j+1]-phi_1d[j-1])/dx1;

  field_1d[0] = field_r_new = -(phi_1d[1]-phi_1d[0])/dx1;
  field_1d[size_N-1] = -(phi_1d[size_N-1]-phi_1d[size_N-2])/dx1;

  I_displ = -eps0*(field_r_new-field_r_old)/dt;

  for (int j = 0; j < size_N; j++){
    // --- electrons:
    mue_1d[j] = e_mobility_te(Te_1d[j],ng0);
    De_1d[j] = mue_1d[j]*Te_1d[j]/11600.0;
    ve_1d[j] = -mue_1d[j]*field_1d[j];
    Deps_1d[j] = 5.0/3.0*De_1d[j];
    ve_eps_1d[j] = 5.0/3.0*ve_1d[j];
    // --- ions:
    mui_1d[j] = mobi_ion(field_1d[j]/ng0)*multi_mu_i;
    vi_1d[j] = mui_1d[j]*field_1d[j];
    Di_1d[j] = 0.029*mui_1d[j];
  }

  Ii_c = gamma_i_1d[size_N/2];
  Ie_c = gamma_e_1d[size_N/2];

  for (int j = 1; j < size_N-1; j++){
    gamma_e_1d[j] = ve_1d[j]*ne_1d[j]-0.5*De_1d[j]*(ne_1d[j+1]-ne_1d[j-1])/dx1;
    gamma_e_adv[j] = ve_1d[j]*ne_1d[j];
    gamma_e_diff[j] = -0.5*De_1d[j]*(ne_1d[j+1]-ne_1d[j-1])/dx1;
    gamma_i_1d[j] = vi_1d[j]*ni_1d[j]-0.5*Di_1d[j]*(ni_1d[j+1]-ni_1d[j-1])/dx1;
  }

  gamma_e_1d[0] = ve_1d[0]*ne_1d[0]-De_1d[0]*(ne_1d[1]-ne_1d[0])/dx1;
  gamma_e_adv[0] = ve_1d[0]*ne_1d[0];
  gamma_e_diff[0] = -De_1d[0]*(ne_1d[1]-ne_1d[0])/dx1;
  gamma_i_1d[0] = vi_1d[0]*ni_1d[0]-Di_1d[0]*(ni_1d[1]-ni_1d[0])/dx1;

  gamma_e_1d[size_N-1] = ve_1d[size_N-1]*ne_1d[size_N-1]-De_1d[size_N-1]*(ne_1d[size_N-1]-ne_1d[size_N-2])/dx1;
  gamma_e_adv[size_N-1] = ve_1d[size_N-1]*ne_1d[size_N-1];
  gamma_e_diff[size_N-1] = -De_1d[size_N-1]*(ne_1d[size_N-1]-ne_1d[size_N-2])/dx1;


  gamma_i_1d[size_N-1] = vi_1d[size_N-1]*ni_1d[size_N-1]-Di_1d[size_N-1]*(ni_1d[size_N-1]-ni_1d[size_N-2])/dx1;

  Ii_r = gamma_i_1d[size_N-2];
  Ie_r = gamma_e_1d[size_N-2];

  Ii_l = gamma_i_1d[1];
  Ie_l = gamma_e_1d[1];

  if (i%100 == 0){
    fprintf(stdout,"%3.3e %3.3e %3.3e %3.3e %3.3e %3.3e %3.3e\n",t*1e6,ne_1d[size_N/2],dt,Ii_l,Ie_l,Ucath_upd,Te_1d[size_N/2]/11600.0);
    fflush(stdout);
  }

  for (int j = 0; j < size_N; j++){
    Kion_1d[j] = ion_coeff_te(Te_1d[j])*ng0*ne_1d[j];
    Kioni_1d[j] = ion_coeff_te(Te_1d[j])*ng0*ne_1d[j];
    Keps[j] = (-qe*(field_1d[j]*gamma_e_1d[j])-ng0*ne_1d[j]*qe*(e_ion*ion_coeff_te(Te_1d[j])+ex1*coeff_ex1_te(Te_1d[j]))-3.0*k_boltz*ne_1d[j]*me/mi*ng0*(Te_1d[j]-Tgas)*moment_coeff_te(Te_1d[j]));
  }

  // --- use drift-diffusion solver for electron density:
  drift_diffusion(ne_1d,ve_1d,De_1d,Kion_1d,dx1,dt,ne_bc_right,ne_bc_left,size_N);

  for (int j = 0; j < size_N; j++)
    if (ne_1d[j] < ne_min) {ne_1d[j] = ne_min;}

  drift_diffusion(neps_1d,ve_eps_1d,Deps_1d,Keps,dx1,dt,neps_bc_right,neps_bc_left,size_N);
  drift_diffusion(ni_1d,vi_1d,Di_1d,Kioni_1d,dx1,dt,ni_bc_right,ni_bc_left,size_N);

  for (int j = 0; j < size_N; j++){
    Te_1d[j] = 2.0/3.0*neps_1d[j]/k_boltz/ne_1d[j];
  }

  if (t > tend-2.0*rf_period){

    if (i%20 == 0){
      char name1[80];
      sprintf (name1, "ne-%3.3e.dat", t*1e6);
      FILE * fp1 = fopen (name1, "w");
      fprintf(fp1,"grid ne ni Te field phi Kion Ge Gi mue ADV DIFF\n");
      for (int j = 0; j < size_N; j++)
        fprintf(fp1,"%3.3e %3.3e %3.3e %3.3e %3.3e %3.3e %3.3e %3.3e %3.3e %3.3e %3.3e %3.3e\n",j*dx1,ne_1d[j],ni_1d[j],Te_1d[j]/11600.0,field_1d[j],phi_1d[j],Kion_1d[j],gamma_e_1d[j],gamma_i_1d[j],mue_1d[j],gamma_e_adv[j],gamma_e_diff[j]);
      fclose(fp1);
    }
  }

  if (t > tend-3.0*rf_period){

    fprintf(fp_currents,"%e %e %e %e %e %e %e %e %e %e %e\n",t,Volt(t),phi_1d[0],fabs(Ii_r)*qe,fabs(Ii_l)*qe,Ii_c*qe,fabs(Ie_r)*qe,fabs(Ie_l)*qe,Ie_c*qe,eps0*(field_w-field_w_old)/dt,field_w);
    fflush(fp_currents);
  }

  Ucath_upd = Volt(t);
}

event end(i=iend){

}

// --------------------------------------------------------------------------
// --- FUNCTIONS USED in the SIMULATION:
// ----------------------------------------------------------------------------
double eps_gas(double T1){
  return eps0;
}
// ------------------------------------------------------------------
double ion_coeff_te(double e){

  e /= 11600.0;

  double ee[183] = {0.100,0.602,1.104,1.606,2.108,2.610,3.112,3.614,4.116,4.618,5.120,5.622,
              6.124,6.626,7.128,7.630,8.132,8.634,9.136,9.638,10.14,10.64,11.14,11.65,12.15,
              12.65,13.15,13.65,14.16,14.66,15.16,15.66,16.16,16.67,17.17,17.67,18.17,18.67,
              19.18,19.68,20.18,20.68,21.18,21.69,22.19,22.69,23.19,23.69,24.20,24.70,25.20,
              25.70,26.20,26.71,27.21,27.71,28.21,28.71,29.22,29.72,30.22,30.72,31.22,31.73,
              32.23,32.73,33.23,33.73,34.24,34.74,35.24,35.74,36.24,36.75,37.25,37.75,38.25,
              38.75,39.26,39.76,40.26,40.76,41.26,41.77,42.27,42.77,43.27,43.77,44.28,44.78,
              45.28,45.78,46.28,46.79,47.29,47.79,48.29,48.79,49.30,49.80,50.30,50.80,51.30,
              51.81,52.31,52.81,53.31,53.82,54.32,54.82,55.32,55.82,56.33,56.83,57.33,57.83,
              58.33,58.84,59.34,59.84,60.34,60.84,61.35,61.85,62.35,62.85,63.35,63.86,64.36,
              64.86,65.36,65.86,66.37,66.87,67.37,67.87,68.37,68.88,69.38,69.88,70.38,70.88,
              71.39,71.89,72.39,72.89,73.39,73.90,74.40,74.90,75.40,75.90,76.41,76.91,77.41,
              77.91,78.41,78.92,79.42,79.92,80.42,80.92,81.43,81.93,82.43,82.93,83.43,83.94,
              84.44,84.94,85.44,85.94,86.45,86.95,87.45,87.95,88.45,88.96,89.46,89.96,90.46,
              90.96,91.47};

  double q[183] = {0.000,0.000,0.000,0.000,0.000,0.2263E-25,0.1725E-23,0.2595E-22,0.1847E-21,
           0.8918E-21,0.3577E-20,0.1349E-19,0.5246E-19,0.2201E-18,0.9111E-18,0.3193E-17,
           0.8910E-17,0.2032E-16,0.3950E-16,0.6808E-16,0.1071E-15,0.1569E-15,0.2171E-15,
           0.2872E-15,0.3662E-15,0.4531E-15,0.5467E-15,0.6461E-15,0.7502E-15,0.8579E-15,
           0.9687E-15,0.1082E-14,0.1196E-14,0.1311E-14,0.1428E-14,0.1544E-14,0.1660E-14,
           0.1776E-14,0.1890E-14,0.2004E-14,0.2117E-14,0.2229E-14,0.2341E-14,0.2450E-14,
           0.2558E-14,0.2664E-14,0.2770E-14,0.2874E-14,0.2977E-14,0.3078E-14,0.3177E-14,
           0.3276E-14,0.3373E-14,0.3468E-14,0.3562E-14,0.3655E-14,0.3747E-14,0.3838E-14,
           0.3929E-14,0.4018E-14,0.4105E-14,0.4190E-14,0.4274E-14,0.4357E-14,0.4441E-14,
           0.4523E-14,0.4604E-14,0.4684E-14,0.4763E-14,0.4841E-14,0.4917E-14,0.4995E-14,
           0.5070E-14,0.5145E-14,0.5218E-14,0.5290E-14,0.5361E-14,0.5433E-14,0.5503E-14,
           0.5573E-14,0.5644E-14,0.5713E-14,0.5781E-14,0.5849E-14,0.5917E-14,0.5984E-14,
           0.6050E-14,0.6114E-14,0.6177E-14,0.6239E-14,0.6302E-14,0.6364E-14,0.6426E-14,
           0.6487E-14,0.6548E-14,0.6609E-14,0.6669E-14,0.6730E-14,0.6790E-14,0.6850E-14,
           0.6909E-14,0.6967E-14,0.7023E-14,0.7078E-14,0.7133E-14,0.7188E-14,0.7243E-14,
           0.7297E-14,0.7351E-14,0.7406E-14,0.7460E-14,0.7512E-14,0.7565E-14,0.7617E-14,
           0.7670E-14,0.7722E-14,0.7773E-14,0.7825E-14,0.7876E-14,0.7928E-14,0.7979E-14,
           0.8029E-14,0.8078E-14,0.8126E-14,0.8175E-14,0.8223E-14,0.8270E-14,0.8316E-14,
           0.8362E-14,0.8410E-14,0.8457E-14,0.8504E-14,0.8552E-14,0.8599E-14,0.8646E-14,
           0.8691E-14,0.8735E-14,0.8779E-14,0.8823E-14,0.8867E-14,0.8910E-14,0.8952E-14,
           0.8995E-14,0.9037E-14,0.9079E-14,0.9121E-14,0.9163E-14,0.9205E-14,0.9247E-14,
           0.9289E-14,0.9332E-14,0.9373E-14,0.9415E-14,0.9456E-14,0.9498E-14,0.9539E-14,
           0.9581E-14,0.9622E-14,0.9662E-14,0.9701E-14,0.9740E-14,0.9779E-14,0.9818E-14,
           0.9856E-14,0.9894E-14,0.9932E-14,0.9970E-14,0.1001E-13,0.1004E-13,0.1008E-13,
           0.1011E-13,0.1015E-13,0.1019E-13,0.1023E-13,0.1027E-13,0.1030E-13,0.1034E-13,
           0.1037E-13,0.1041E-13,0.1044E-13,0.1048E-13,0.1051E-13,0.1055E-13};

  if (e > ee[182])
    return q[182];

  int i;

  for (i = 1; i < 183; i++)
    if (e <= ee[i]) break;

  int i1 = i-1;

  double CS = (q[i]-q[i1])*(e-ee[i1])/(ee[i]-ee[i1])+q[i1];
  if (CS < 0.0) CS = 0.0;
  return CS; //in [m2/V-s]
}
// ------------------------------------------------------------------
double coeff_ex1_te(double e){

  e /= 11600.0;

  double ee[183] = {0.100,0.602,1.104,1.606,2.108,2.610,3.112,3.614,4.116,4.618,5.120,5.622,
              6.124,6.626,7.128,7.630,8.132,8.634,9.136,9.638,10.14,10.64,11.14,11.65,12.15,
              12.65,13.15,13.65,14.16,14.66,15.16,15.66,16.16,16.67,17.17,17.67,18.17,18.67,
              19.18,19.68,20.18,20.68,21.18,21.69,22.19,22.69,23.19,23.69,24.20,24.70,25.20,
              25.70,26.20,26.71,27.21,27.71,28.21,28.71,29.22,29.72,30.22,30.72,31.22,31.73,
              32.23,32.73,33.23,33.73,34.24,34.74,35.24,35.74,36.24,36.75,37.25,37.75,38.25,
              38.75,39.26,39.76,40.26,40.76,41.26,41.77,42.27,42.77,43.27,43.77,44.28,44.78,
              45.28,45.78,46.28,46.79,47.29,47.79,48.29,48.79,49.30,49.80,50.30,50.80,51.30,
              51.81,52.31,52.81,53.31,53.82,54.32,54.82,55.32,55.82,56.33,56.83,57.33,57.83,
              58.33,58.84,59.34,59.84,60.34,60.84,61.35,61.85,62.35,62.85,63.35,63.86,64.36,
              64.86,65.36,65.86,66.37,66.87,67.37,67.87,68.37,68.88,69.38,69.88,70.38,70.88,
              71.39,71.89,72.39,72.89,73.39,73.90,74.40,74.90,75.40,75.90,76.41,76.91,77.41,
              77.91,78.41,78.92,79.42,79.92,80.42,80.92,81.43,81.93,82.43,82.93,83.43,83.94,
              84.44,84.94,85.44,85.94,86.45,86.95,87.45,87.95,88.45,88.96,89.46,89.96,90.46,
              90.96,91.47};

  double q[183] = {0.000,0.000,0.000,0.000,0.1741E-23,0.4391E-21,0.8820E-20,0.5583E-19,
          0.2006E-18,0.5338E-18,0.1210E-17,0.2531E-17,0.5159E-17,0.1055E-16,0.2112E-16,
          0.3923E-16,0.6613E-16,0.1021E-15,0.1464E-15,0.1979E-15,0.2555E-15,0.3174E-15,
          0.3821E-15,0.4484E-15,0.5154E-15,0.5822E-15,0.6483E-15,0.7131E-15,0.7765E-15,
          0.8383E-15,0.8983E-15,0.9565E-15,0.1013E-14,0.1067E-14,0.1121E-14,0.1172E-14,
          0.1222E-14,0.1270E-14,0.1316E-14,0.1361E-14,0.1405E-14,0.1448E-14,0.1489E-14,
          0.1530E-14,0.1569E-14,0.1607E-14,0.1644E-14,0.1680E-14,0.1716E-14,0.1751E-14,
          0.1784E-14,0.1817E-14,0.1849E-14,0.1880E-14,0.1911E-14,0.1941E-14,0.1971E-14,
          0.2000E-14,0.2029E-14,0.2057E-14,0.2085E-14,0.2112E-14,0.2138E-14,0.2163E-14,
          0.2189E-14,0.2215E-14,0.2239E-14,0.2264E-14,0.2287E-14,0.2310E-14,0.2333E-14,
          0.2357E-14,0.2380E-14,0.2402E-14,0.2423E-14,0.2444E-14,0.2465E-14,0.2486E-14,
          0.2507E-14,0.2527E-14,0.2548E-14,0.2568E-14,0.2588E-14,0.2607E-14,0.2626E-14,
          0.2646E-14,0.2664E-14,0.2683E-14,0.2701E-14,0.2719E-14,0.2737E-14,0.2754E-14,
          0.2772E-14,0.2789E-14,0.2806E-14,0.2823E-14,0.2840E-14,0.2857E-14,0.2873E-14,
          0.2890E-14,0.2906E-14,0.2921E-14,0.2937E-14,0.2952E-14,0.2967E-14,0.2982E-14,
          0.2998E-14,0.3013E-14,0.3027E-14,0.3042E-14,0.3057E-14,0.3071E-14,0.3085E-14,
          0.3099E-14,0.3113E-14,0.3127E-14,0.3140E-14,0.3154E-14,0.3167E-14,0.3181E-14,
          0.3195E-14,0.3208E-14,0.3221E-14,0.3234E-14,0.3247E-14,0.3259E-14,0.3272E-14,
          0.3284E-14,0.3296E-14,0.3309E-14,0.3321E-14,0.3333E-14,0.3345E-14,0.3358E-14,
          0.3370E-14,0.3382E-14,0.3393E-14,0.3404E-14,0.3416E-14,0.3427E-14,0.3438E-14,
          0.3449E-14,0.3460E-14,0.3470E-14,0.3481E-14,0.3492E-14,0.3502E-14,0.3513E-14,
          0.3524E-14,0.3535E-14,0.3546E-14,0.3556E-14,0.3567E-14,0.3577E-14,0.3588E-14,
          0.3598E-14,0.3608E-14,0.3619E-14,0.3628E-14,0.3638E-14,0.3647E-14,0.3657E-14,
          0.3666E-14,0.3676E-14,0.3685E-14,0.3695E-14,0.3704E-14,0.3713E-14,0.3721E-14,
          0.3731E-14,0.3740E-14,0.3749E-14,0.3759E-14,0.3768E-14,0.3777E-14,0.3785E-14,
          0.3793E-14,0.3802E-14,0.3811E-14,0.3819E-14,0.3828E-14,0.3836E-14,0.3844E-14};

  if (e > ee[182])
    return q[182];

  int i;

  for (i = 1; i < 183; i++)
    if (e <= ee[i]) break;

  int i1 = i-1;

  double CS = (q[i]-q[i1])*(e-ee[i1])/(ee[i]-ee[i1])+q[i1];
  if (CS < 0.0) CS = 0.0;
  return CS;
}
// ------------------------------------------------------------------
double e_mobility_te(double e, double ng1){

  e /= 11600.0;

  double ee[183] = {0.100,0.602,1.104,1.606,2.108,2.610,3.112,3.614,4.116,4.618,5.120,5.622,
              6.124,6.626,7.128,7.630,8.132,8.634,9.136,9.638,10.14,10.64,11.14,11.65,12.15,
              12.65,13.15,13.65,14.16,14.66,15.16,15.66,16.16,16.67,17.17,17.67,18.17,18.67,
              19.18,19.68,20.18,20.68,21.18,21.69,22.19,22.69,23.19,23.69,24.20,24.70,25.20,
              25.70,26.20,26.71,27.21,27.71,28.21,28.71,29.22,29.72,30.22,30.72,31.22,31.73,
              32.23,32.73,33.23,33.73,34.24,34.74,35.24,35.74,36.24,36.75,37.25,37.75,38.25,
              38.75,39.26,39.76,40.26,40.76,41.26,41.77,42.27,42.77,43.27,43.77,44.28,44.78,
              45.28,45.78,46.28,46.79,47.29,47.79,48.29,48.79,49.30,49.80,50.30,50.80,51.30,
              51.81,52.31,52.81,53.31,53.82,54.32,54.82,55.32,55.82,56.33,56.83,57.33,57.83,
              58.33,58.84,59.34,59.84,60.34,60.84,61.35,61.85,62.35,62.85,63.35,63.86,64.36,
              64.86,65.36,65.86,66.37,66.87,67.37,67.87,68.37,68.88,69.38,69.88,70.38,70.88,
              71.39,71.89,72.39,72.89,73.39,73.90,74.40,74.90,75.40,75.90,76.41,76.91,77.41,
              77.91,78.41,78.92,79.42,79.92,80.42,80.92,81.43,81.93,82.43,82.93,83.43,83.94,
              84.44,84.94,85.44,85.94,86.45,86.95,87.45,87.95,88.45,88.96,89.46,89.96,90.46,
              90.96,91.47};

  double q[183] = {0.1319E+26,0.4673E+25,0.3387E+25,0.2836E+25,0.2542E+25,0.2368E+25,
          0.2262E+25,0.2197E+25,0.2158E+25,0.2137E+25,0.2131E+25,0.2136E+25,0.2151E+25,
          0.2173E+25,0.2199E+25,0.2230E+25,0.2266E+25,0.2305E+25,0.2347E+25,0.2388E+25,
          0.2429E+25,0.2468E+25,0.2505E+25,0.2540E+25,0.2572E+25,0.2602E+25,0.2628E+25,
          0.2653E+25,0.2677E+25,0.2697E+25,0.2716E+25,0.2733E+25,0.2748E+25,0.2761E+25,
          0.2776E+25,0.2785E+25,0.2797E+25,0.2806E+25,0.2813E+25,0.2822E+25,0.2828E+25,
          0.2835E+25,0.2841E+25,0.2847E+25,0.2851E+25,0.2854E+25,0.2858E+25,0.2865E+25,
          0.2868E+25,0.2871E+25,0.2872E+25,0.2874E+25,0.2878E+25,0.2878E+25,0.2878E+25,
          0.2880E+25,0.2883E+25,0.2887E+25,0.2892E+25,0.2895E+25,0.2896E+25,0.2895E+25,
          0.2894E+25,0.2893E+25,0.2897E+25,0.2900E+25,0.2900E+25,0.2901E+25,0.2902E+25,
          0.2903E+25,0.2901E+25,0.2904E+25,0.2905E+25,0.2905E+25,0.2904E+25,0.2902E+25,
          0.2901E+25,0.2901E+25,0.2902E+25,0.2902E+25,0.2903E+25,0.2903E+25,0.2904E+25,
          0.2904E+25,0.2906E+25,0.2908E+25,0.2909E+25,0.2908E+25,0.2907E+25,0.2907E+25,
          0.2905E+25,0.2905E+25,0.2905E+25,0.2905E+25,0.2904E+25,0.2905E+25,0.2906E+25,
          0.2907E+25,0.2908E+25,0.2909E+25,0.2911E+25,0.2911E+25,0.2909E+25,0.2908E+25,
          0.2906E+25,0.2905E+25,0.2904E+25,0.2904E+25,0.2904E+25,0.2905E+25,0.2905E+25,
          0.2904E+25,0.2903E+25,0.2903E+25,0.2903E+25,0.2903E+25,0.2904E+25,0.2905E+25,
          0.2906E+25,0.2907E+25,0.2908E+25,0.2908E+25,0.2907E+25,0.2906E+25,0.2905E+25,
          0.2905E+25,0.2905E+25,0.2903E+25,0.2902E+25,0.2903E+25,0.2903E+25,0.2904E+25,
          0.2905E+25,0.2906E+25,0.2907E+25,0.2906E+25,0.2905E+25,0.2904E+25,0.2904E+25,
          0.2904E+25,0.2903E+25,0.2902E+25,0.2901E+25,0.2900E+25,0.2900E+25,0.2900E+25,
          0.2900E+25,0.2900E+25,0.2900E+25,0.2900E+25,0.2901E+25,0.2901E+25,0.2901E+25,
          0.2901E+25,0.2901E+25,0.2902E+25,0.2903E+25,0.2904E+25,0.2904E+25,0.2905E+25,
          0.2905E+25,0.2904E+25,0.2904E+25,0.2904E+25,0.2904E+25,0.2904E+25,0.2904E+25,
          0.2904E+25,0.2899E+25,0.2899E+25,0.2900E+25,0.2900E+25,0.2901E+25,0.2902E+25,
          0.2902E+25,0.2903E+25,0.2903E+25,0.2903E+25,0.2902E+25,0.2902E+25,0.2902E+25,
          0.2902E+25,0.2902E+25};

  if (e > ee[182])
    return q[182]/ng1;

  if (e < ee[0])
    return q[0]/ng1;

  int i;

  for (i = 1; i < 183; i++)
    if (e <= ee[i]) break;

  int i1 = i-1;

  double CS = (q[i]-q[i1])*(e-ee[i1])/(ee[i]-ee[i1])+q[i1];
  if (CS < 0.0) CS = 0.0;
  return CS/ng1;
}
// ------------------------------------------------------------------
double moment_coeff_te(double e){ //He+ mobility

  e /= 11600.0;

  double ee[183] = {0.100,0.602,1.104,1.606,2.108,2.610,3.112,3.614,4.116,4.618,5.120,
                    5.622,6.124,6.626,7.128,7.630,8.132,8.634,9.136,9.638,10.14,10.64,
                    11.14,11.65,12.15,12.65,13.15,13.65,14.16,14.66,15.16,15.66,16.16,
                    16.67,17.17,17.67,18.17,18.67,19.18,19.68,20.18,20.68,21.18,21.69,
                    22.19,22.69,23.19,23.69,24.20,24.70,25.20,25.70,26.20,26.71,27.21,
                    27.71,28.21,28.71,29.22,29.72,30.22,30.72,31.22,31.73,32.23,32.73,
                    33.23,33.73,34.24,34.74,35.24,35.74,36.24,36.75,37.25,37.75,38.25,
                    38.75,39.26,39.76,40.26,40.76,41.26,41.77,42.27,42.77,43.27,43.77,
                    44.28,44.78,45.28,45.78,46.28,46.79,47.29,47.79,48.29,48.79,49.30,
                    49.80,50.30,50.80,51.30,51.81,52.31,52.81,53.31,53.82,54.32,54.82,
                    55.32,55.82,56.33,56.83,57.33,57.83,58.33,58.84,59.34,59.84,60.34,
                    60.84,61.35,61.85,62.35,62.85,63.35,63.86,64.36,64.86,65.36,65.86,
                    66.37,66.87,67.37,67.87,68.37,68.88,69.38,69.88,70.38,70.88,71.39,
                    71.89,72.39,72.89,73.39,73.90,74.40,74.90,75.40,75.90,76.41,76.91,
                    77.41,77.91,78.41,78.92,79.42,79.92,80.42,80.92,81.43,81.93,82.43,
                    82.93,83.43,83.94,84.44,84.94,85.44,85.94,86.45,86.95,87.45,87.95,
                    88.45,88.96,89.46,89.96,90.46,90.96,91.47};

  double q[183] = {0.1043E-13,0.2904E-13,0.4037E-13,0.4880E-13,0.5528E-13,0.6030E-13,
           0.6420E-13,0.6727E-13,0.6973E-13,0.7171E-13,0.7332E-13,0.7459E-13,0.7555E-13,
           0.7626E-13,0.7678E-13,0.7714E-13,0.7730E-13,0.7727E-13,0.7709E-13,0.7680E-13,
           0.7642E-13,0.7600E-13,0.7554E-13,0.7507E-13,0.7460E-13,0.7413E-13,0.7367E-13,
           0.7322E-13,0.7279E-13,0.7238E-13,0.7198E-13,0.7161E-13,0.7125E-13,0.7090E-13,
           0.7057E-13,0.7026E-13,0.6996E-13,0.6967E-13,0.6940E-13,0.6914E-13,0.6889E-13,
           0.6865E-13,0.6842E-13,0.6819E-13,0.6798E-13,0.6778E-13,0.6758E-13,0.6738E-13,
           0.6720E-13,0.6702E-13,0.6686E-13,0.6669E-13,0.6653E-13,0.6637E-13,0.6622E-13,
           0.6607E-13,0.6593E-13,0.6578E-13,0.6564E-13,0.6550E-13,0.6537E-13,0.6525E-13,
           0.6513E-13,0.6502E-13,0.6489E-13,0.6477E-13,0.6465E-13,0.6454E-13,0.6443E-13,
           0.6433E-13,0.6423E-13,0.6413E-13,0.6402E-13,0.6393E-13,0.6384E-13,0.6374E-13,
           0.6365E-13,0.6356E-13,0.6347E-13,0.6338E-13,0.6329E-13,0.6320E-13,0.6311E-13,
           0.6303E-13,0.6294E-13,0.6286E-13,0.6278E-13,0.6270E-13,0.6262E-13,0.6254E-13,
           0.6247E-13,0.6239E-13,0.6231E-13,0.6224E-13,0.6216E-13,0.6209E-13,0.6202E-13,
           0.6194E-13,0.6187E-13,0.6180E-13,0.6173E-13,0.6166E-13,0.6160E-13,0.6154E-13,
           0.6147E-13,0.6141E-13,0.6134E-13,0.6128E-13,0.6121E-13,0.6115E-13,0.6109E-13,
           0.6103E-13,0.6097E-13,0.6091E-13,0.6085E-13,0.6079E-13,0.6073E-13,0.6067E-13,
           0.6061E-13,0.6056E-13,0.6050E-13,0.6044E-13,0.6038E-13,0.6033E-13,0.6027E-13,
           0.6022E-13,0.6017E-13,0.6012E-13,0.6006E-13,0.6002E-13,0.5997E-13,0.5991E-13,
           0.5986E-13,0.5981E-13,0.5975E-13,0.5970E-13,0.5965E-13,0.5960E-13,0.5956E-13,
           0.5951E-13,0.5946E-13,0.5941E-13,0.5937E-13,0.5932E-13,0.5927E-13,0.5923E-13,
           0.5918E-13,0.5913E-13,0.5909E-13,0.5904E-13,0.5899E-13,0.5894E-13,0.5890E-13,
           0.5885E-13,0.5881E-13,0.5876E-13,0.5872E-13,0.5867E-13,0.5863E-13,0.5859E-13,
           0.5855E-13,0.5850E-13,0.5846E-13,0.5842E-13,0.5838E-13,0.5834E-13,0.5830E-13,
           0.5826E-13,0.5822E-13,0.5818E-13,0.5814E-13,0.5810E-13,0.5806E-13,0.5802E-13,
           0.5798E-13,0.5794E-13,0.5790E-13,0.5786E-13,0.5782E-13,0.5779E-13,0.5775E-13,
           0.5771E-13,0.5767E-13};

  if (e > ee[182])
    return q[182];

  if (e < ee[0])
    return q[0];

  int i;

  for (i = 1; i < 183; i++)
    if (e <= ee[i]) break;

  int i1 = i-1;

  double CS = (q[i]-q[i1])*(e-ee[i1])/(ee[i]-ee[i1])+q[i1];
  if (CS < 0.0) CS = 0.0;
  return CS;
}
// ------------------------------------------------------------------
double mobi_ion(double e){ //He+ mobility

  e = fabs(e);

  double ee[31] = {0.0e-21,6.0e-21,8e-21,1.0e-20,1.2e-20,1.5e-20,2e-20,2.5e-20,3e-20,4e-20,
           5.0e-20,6.0e-20,8.0e-20,1.0e-19,1.2e-19,1.5e-19,2e-19,2.5e-19,3.0e-19,4.0e-19,
           5e-19,6.0e-19,7e-19,1e-18,1.4e-18,1.8e-18,2.2e-18,2.6e-18,3.0e-18,5.0e-18,1e-17};

  double q[31] = {10.4,10.3,10.2,10.2,10.1,10.0,9.90,9.74,9.60,9.28,8.97,8.67,8.12,7.67,7.25,
           6.78,6.12,5.6,5.19,4.58,4.17,3.81,3.57,2.99,2.52,2.23,2.01,1.85,1.72,1.34,0.94};

  if (e > ee[30])
    return q[30];

  int i;

  for (i = 1; i < 31; i++)
    if (e <= ee[i]) break;

  int i1 = i-1;
  double CS = (q[i]-q[i1])*(e-ee[i1])/(ee[i]-ee[i1])+q[i1];
  if (CS < 0.0) CS = 0.0;
  return CS; //in [m2/V-s]
}
// --------------------------------------------------------------------
// --- tridiagonal matrix solver:
void tdma(double A[], double B[], double C[], double W[], double bc_left, double bc_right, double ans[], int size0){

  double x[size0-1], y[size0-1];

  int j = size0-2;
  x[size0-2] = 0.0; // 1.0 for zero derivative at the right boundary; otherwise 0.0
  y[size0-2] = bc_right;

  while (j >= 1){
    x[j-1] = -C[j]/(A[j]*x[j]+B[j]);
    y[j-1] = (W[j]-A[j]*y[j])/(A[j]*x[j]+B[j]);
    j--;
  }
  ans[0] = bc_left;

  for (j = 0; j < size0-1; j++){
    ans[j+1] = x[j]*ans[j]+y[j];
  }
}
// ----------------------------------------------------------------------
double B_dd(double z){

  if (fabs(z) <= 1e-6){
    return 1.0-0.5*z+sq(z)/12.0-sq(z*z)/720.0;
  }else{
    return z/(exp(z)-1.0);
  }
}
// ----------------------------------------------------------------------
double W_dd(double z){

  if (fabs(z) <= 1e-6){
    return 0.5-z/12.0+z*z*z/720.0;
  }else{
    return (1.0-B_dd(z))/z;
  }
}
// ----------------------------------------------------------------------
void drift_diffusion(double dens[],double veloc[],double Diff_coeff[], double source[], double dx, double dt0, double bc_right, double bc_left, int size0){

  double P[size0],alfa0[size0-1],beta0[size0-1],gamma0[size0-1],del0[size0-1];
  double P_a_aw[size0-1],P_w_av[size0-1]; //arithmetic and weighted average Peclet number
  double D_w[size0-1],D_w_av[size0-1]; //weighted diffusion coefficient

  for (int j = 0; j < size0; j++)
    P[j] = dx*veloc[j]/Diff_coeff[j];

  for (int j = 0; j < size0-1; j++)
    P_a_aw[j] = 0.5*(P[j]+P[j+1]);

  for (int j = 0; j < size0-1; j++)
    P_w_av[j] = W_dd(-P_a_aw[j])*P[j]+W_dd(P_a_aw[j])*P[j+1];

  for (int j = 0; j < size0-1; j++)
    D_w_av[j] = W_dd(-P_a_aw[j])*Diff_coeff[j]+W_dd(P_a_aw[j])*Diff_coeff[j+1];

  for (int j = 0; j < size0-1; j++)
    D_w[j] = P_w_av[j]/P_a_aw[j]*D_w_av[j];

  for (int j = 0; j < size0-1; j++){
    alfa0[j] = D_w[j]*B_dd(-P_a_aw[j])/dx;
    beta0[j] = D_w[j]*B_dd(P_a_aw[j])/dx;
    gamma0[j] = max(0.5-W_dd(P_a_aw[j]),0.0);
    del0[j] = min(0.5-W_dd(P_a_aw[j]),0.0);
  }

  // --- fill out the matrices for tridiagonal solver:
  double A0[size0],B0[size0],C0[size0],W0[size0];
  for (int j = 1; j < size0-1; j++){
    A0[j] = -dt0*beta0[j];
    B0[j] = dx+dt0*alfa0[j]+dt0*beta0[j-1];
    C0[j] = -dt0*alfa0[j-1];
    W0[j] = dx*dens[j]-dt0*dx*(gamma0[j]*source[j]+del0[j]*source[j+1])+
       dt0*dx*(gamma0[j-1]*source[j-1]+del0[j-1]*source[j])+
       dt0*dx*source[j];
  }

  A0[0] = -dt0*beta0[0];
  B0[0] = dx+dt0*alfa0[0];
  C0[0] = 0.0;
  W0[0] = dx*dens[0]-dt0*dx*(gamma0[0]*source[0]+del0[0]*source[1])+
          dt0*dx*source[0];

  A0[size0-1] = -dt0*beta0[size0-1];
  B0[size0-1] = dx+dt0*alfa0[size0-1]+dt0*beta0[size0-2];
  C0[size0-1] = -dt0*alfa0[size0-2];
  W0[size0-1] = dx*dens[size0-1]-dt0*dx*(gamma0[size0-1]*source[size0-1])+
       dt0*dx*(gamma0[size0-2]*source[size0-2]+del0[size0-2]*source[size0-1])+
       dt0*dx*source[size0-1];

  tdma(A0,B0,C0,W0,bc_left,bc_right,dens,size0);

}
// ------------------------------------------------
void update_phi(double phi_upd[], double bc_right, double bc_left, double rhs[], int size0){

  double A0[size0],B0[size0],C0[size0],W0[size0];

  for (int j = 0; j < size0; j++){
    A0[j] = 1.0;
    B0[j] = -2.0;
    C0[j] = 1.0;
    W0[j] = rhs[j];
  }

  tdma(A0,B0,C0,W0,bc_left,bc_right,phi_upd,size0);
}